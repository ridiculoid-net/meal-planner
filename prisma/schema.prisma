// Prisma schema for the recipe and meal planning app

// Datasource definition. Supabase uses PostgreSQL
datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// Generate the Prisma client
generator client {
  provider = "prisma-client-js"
}

/// Enum definitions
enum RecipeSourceType {
  auto
  imported
  custom
}

enum ReactionType {
  heart
  skip
}

enum MealSlot {
  breakfast
  lunch
  dinner
}

enum InventoryLocation {
  pantry
  fridge
  freezer
}

enum GrocerySection {
  produce
  meat_seafood
  dairy_eggs
  pantry
  frozen
  bakery
  spices
}

enum GroceryStatus {
  active
  completed
}

/// User account created via NextAuth.
/// Users can belong to multiple households via HouseholdMember.
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  image     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  profile       UserProfile?
  households    HouseholdMember[]
  reactions     RecipeReaction[]
  mealPlanItems MealPlanItem[]
  bookmarks     RecipeBookmark[]
  reviews       RecipeReview[]
}

model Household {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  members        HouseholdMember[]
  recipes        Recipe[]
  mealPlans      MealPlan[]
  inventoryItems InventoryItem[]
  groceryLists   GroceryList[]
}

model HouseholdMember {
  id          String   @id @default(uuid())
  userId      String
  householdId String
  role        String   @default("member")
  joinedAt    DateTime @default(now())

  // Relationships
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)

  @@unique([userId, householdId])
}

/// Extended user data used for personalization (height, weight, diets, etc.).
model UserProfile {
  id                  String   @id @default(uuid())
  userId              String   @unique
  heightCm            Float?
  weightKg            Float?
  ageYears            Int?
  householdSize       Int      @default(1)
  goal                String? // maintain, lose, gain
  activityLevel       String? // sedentary, light, moderate, active
  // store dietary preferences, allergies, favorite cuisines, meats, vegetables, dislikes as json arrays
  diets               Json?
  allergies           Json?
  favoriteCuisines    Json?
  favoriteMeats       Json?
  favoriteVegetables  Json?
  dislikedIngredients Json?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Recipe {
  id          String           @id @default(uuid())
  title       String
  description String?
  image       String?
  servings    Float            @default(1)
  sourceType  RecipeSourceType
  isGlobal    Boolean          @default(false)
  attribution Json? // provider attribution details
  householdId String? // null when global
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  tags        Json? // cuisines, diets, allergens, etc.
  nutrition   Json? // computed nutrition information

  // Relationships
  household     Household?         @relation(fields: [householdId], references: [id])
  ingredients   RecipeIngredient[]
  steps         RecipeStep[]
  reactions     RecipeReaction[]
  mealPlanItems MealPlanItem[]

  // Additional relations
  bookmarks RecipeBookmark[]
  reviews   RecipeReview[]
}

model RecipeIngredient {
  id        String   @id @default(uuid())
  recipeId  String
  name      String
  quantity  Float
  unit      String
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)
}

model RecipeStep {
  id        String   @id @default(uuid())
  recipeId  String
  order     Int
  text      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@unique([recipeId, order])
}

model RecipeReaction {
  id        String       @id @default(uuid())
  userId    String
  recipeId  String
  type      ReactionType
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@unique([userId, recipeId])
}

/// Bookmark a recipe for later. Each user can bookmark a recipe once.
model RecipeBookmark {
  id        String   @id @default(uuid())
  userId    String
  recipeId  String
  createdAt DateTime @default(now())

  // Relationships
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@unique([userId, recipeId])
}

/// User-submitted review for a recipe, including rating (1â€“5) and optional comment.
model RecipeReview {
  id        String   @id @default(uuid())
  userId    String
  recipeId  String
  rating    Float
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)
}

model MealPlan {
  id          String   @id @default(uuid())
  householdId String
  startDate   DateTime
  endDate     DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  household Household      @relation(fields: [householdId], references: [id], onDelete: Cascade)
  items     MealPlanItem[]
}

model MealPlanItem {
  id         String   @id @default(uuid())
  mealPlanId String
  recipeId   String
  date       DateTime
  slot       String
  servings   Float    @default(1)
  leftovers  Boolean  @default(false)

  // ADD THESE:
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  mealPlan MealPlan @relation(fields: [mealPlanId], references: [id], onDelete: Cascade)
  recipe   Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([mealPlanId])
  @@index([recipeId])
  @@index([userId]) // ADD
}

model InventoryItem {
  id             String            @id @default(uuid())
  householdId    String
  name           String
  quantity       Float
  unit           String
  location       InventoryLocation
  expirationDate DateTime?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
}

model GroceryList {
  id          String        @id @default(uuid())
  householdId String
  status      GroceryStatus @default(active)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  household Household         @relation(fields: [householdId], references: [id], onDelete: Cascade)
  items     GroceryListItem[]
}

model GroceryListItem {
  id            String         @id @default(uuid())
  groceryListId String
  name          String
  quantity      Float
  unit          String
  section       GrocerySection
  checked       Boolean        @default(false)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  groceryList GroceryList @relation(fields: [groceryListId], references: [id], onDelete: Cascade)
}
